require 'rake/clean'
require "bundler/gem_tasks"
require "pathname"
require "yaml"
require "rake/testtask"

extsources = YAML.load_file("extsources.yaml")
extsources.each_pair do |src_dir, dests|
  dests.each do |dest|
    src = Pathname(src_dir)/File.basename(dest)

    file src
    file dest => src do |t|
      cp t.source, t.name
    end
  end
end
SOURCES = extsources.values.flatten
CLEAN.include SOURCES

task build: SOURCES + FileList[
                        "ext/extconf.rb",
                        "ext/ruby_whisper.h",
                        "ext/ruby_whisper.cpp",
                        "whispercpp.gemspec",
                      ]

directory "pkg"
CLOBBER.include "pkg"

Rake::TestTask.new do |t|
  t.test_files = FileList["tests/test_*.rb"]
end
